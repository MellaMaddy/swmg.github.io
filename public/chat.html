<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PURRLOCK</title>
    <link rel="stylesheet" href="login.css" />
</head>
<body>
    <div id="chat-layout" style="display: flex; gap: 20px; padding: 20px;">
        <!-- USER LIST PANEL -->
        <div id="user-list-panel" style="width: 200px;">
            <h3>Users</h3>
            <ul id="user-list"></ul>
        </div>

        <!-- MAIN CHAT -->
        <div class="chat-container" style="flex: 1;">
            <h2>Main Chat</h2>

            <ul id="messages"></ul>

            <form id="chat-form">
                <input type="text" id="msg" placeholder="Type your message..." autocomplete="off" required />
                <button type="submit">Send</button>
            </form>

            <button id="back-to-main" style="display:none; margin-top:10px;">Return to Main Chat</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let username = null;
        let currentPrivateUser = null;
        let encryptionKey = null;

        // Fetch user session
        fetch('/api/current-user')
            .then(res => res.json())
            .then(data => {
                username = data.username;
            });

        // Request chat history
        socket.emit("request history");

        // Receive chat history
        socket.on("chat history", (history) => {
            history.forEach(msg => addMessage(msg.user, msg.text));
        });

        // Update user list
        socket.on("user list", (users) => {
            const list = document.getElementById("user-list");
            list.innerHTML = "";

            users.forEach(u => {
                if (u !== username) {
                    const li = document.createElement("li");
                    li.textContent = u;
                    li.onclick = () => openPrivateChat(u);
                    list.appendChild(li);
                }
            });
        });

        // Open encrypted private chat
        function openPrivateChat(targetUser) {
            const key = prompt(`Enter encryption key to chat privately with ${targetUser}`);
            if (!key) return;

            encryptionKey = key;
            currentPrivateUser = targetUser;

            document.querySelector("h2").textContent = `Private Chat with ${targetUser}`;
            document.getElementById("back-to-main").style.display = "block";
            document.getElementById("messages").innerHTML = "";
        }

        // Return to main chat
        document.getElementById("back-to-main").onclick = () => {
            currentPrivateUser = null;
            encryptionKey = null;

            document.querySelector("h2").textContent = "Main Chat";
            document.getElementById("back-to-main").style.display = "none";
            document.getElementById("messages").innerHTML = "";

            socket.emit("request history");
        };

        // Add message to chat window
        function addMessage(user, text, isPrivate = false) {
            const li = document.createElement("li");
            li.innerHTML = `<strong>${isPrivate ? '(Private) ' : ''}${user}:</strong> ${text}`;
            document.getElementById("messages").appendChild(li);
        }

        // Send chat message
        document.getElementById("chat-form").onsubmit = (e) => {
            e.preventDefault();
            const input = document.getElementById("msg");
            const text = input.value.trim();
            if (!text) return;

            if (currentPrivateUser && encryptionKey) {
                const encrypted = btoa(text + ':' + encryptionKey);
                socket.emit("private message", {
                    to: currentPrivateUser,
                    message: encrypted,
                    from: username
                });
            } else {
                socket.emit("chat message", { user: username, text });
            }

            input.value = "";
        };

        // Receive private message
        socket.on("private message", ({ from, message }) => {
            if (!encryptionKey) return;

            let decrypted;
            try {
                const decoded = atob(message);
                const parts = decoded.split(":");
                const text = parts.slice(0, -1).join(":");
                const key = parts[parts.length - 1];

                if (key !== encryptionKey) return;
                decrypted = text;
            } catch {
                return;
            }

            addMessage(from, decrypted, true);
        });

        // Receive public message
        socket.on("chat message", (msg) => {
            if (!currentPrivateUser) addMessage(msg.user, msg.text);
        });
    </script>
</body>
</html>
