<script src="/socket.io/socket.io.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script>
const messagesList = document.getElementById("messages");
const userListEl = document.getElementById("user-list");
const socket = io();

// Store computed keys for private chats
const chatKeys = {};

// Get current user's username from the server (via a small API call)
let currentUser = "";
fetch("/api/current-user")
  .then(res => res.json())
  .then(data => { currentUser = data.username; });

// Utility: generate AES key from two usernames
function generateKey(userA, userB) {
  // Sort usernames to get the same result for both users
  const sorted = [userA, userB].sort().join(":");
  return CryptoJS.SHA256(sorted).toString(); // 256-bit key
}

// Update user list
socket.on("user list", users => {
  userListEl.innerHTML = "";
  users.forEach(u => {
    if(u === currentUser) return; // Skip yourself
    const li = document.createElement("li");
    li.textContent = u;
    li.onclick = () => {
      // Compute or retrieve key
      if(!chatKeys[u]) chatKeys[u] = generateKey(currentUser, u);
      
      const msg = prompt(`Send private message to ${u}:`);
      if(!msg) return;

      const encrypted = CryptoJS.AES.encrypt(msg, chatKeys[u]).toString();
      socket.emit("private message", { to: u, message: encrypted });
    };
    userListEl.appendChild(li);
  });
});

// RECEIVE PRIVATE MESSAGE
socket.on("private message", ({ from, message }) => {
  if(!chatKeys[from]) {
    chatKeys[from] = generateKey(currentUser, from);
  }
  const decrypted = CryptoJS.AES.decrypt(message, chatKeys[from]).toString(CryptoJS.enc.Utf8);
  const li = document.createElement("li");
  li.className = "message private";
  li.innerHTML = `<strong>(Private) ${from}:</strong> ${decrypted}`;
  messagesList.appendChild(li);
  messagesList.scrollTop = messagesList.scrollHeight;
});

// PUBLIC MESSAGE (plaintext)
socket.on("chat message", msg => {
  const li = document.createElement("li");
  li.className = "message";
  li.innerHTML = `<strong>${msg.user}:</strong> ${msg.text}`;
  messagesList.appendChild(li);
  messagesList.scrollTop = messagesList.scrollHeight;
});

// SEND PUBLIC MESSAGE
document.getElementById("chat-form").onsubmit = e => {
  e.preventDefault();
  const text = document.getElementById("msg").value.trim();
  if(!text) return;
  socket.emit("chat message", { text });
  document.getElementById("msg").value = "";
};
</script>

